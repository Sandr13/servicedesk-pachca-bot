# servicedesk-pachca-bot
–≠—Ç–æ—Ç –ø—Ä–æ–µ–∫—Ç ‚Äî —Å–µ—Ä–≤–µ—Äless-–æ–±—Ä–∞–±–æ—Ç—á–∏–∫ (–æ–±—ã—á–Ω–æ —Ä–∞–∑–º–µ—â—ë–Ω–Ω—ã–π –≤ –Ø–Ω–¥–µ–∫—Å –§—É–Ω–∫—Ü–∏–∏), –∫–æ—Ç–æ—Ä—ã–π –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –¥–≤—É—Å—Ç–æ—Ä–æ–Ω–Ω—é—é —Å–≤—è–∑—å –º–µ–∂–¥—É Pachca –∏ –Ø–Ω–¥–µ–∫—Å.Tracker.

# –§–∞–π–ª index.py —Ä–µ–∞–ª–∏–∑—É–µ—Ç:

- —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–¥–∞—á –≤ –¢—Ä–µ–∫–µ—Ä–µ –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –ü–∞—á–∫–µ
- –æ–±—Ä–∞—Ç–Ω—É—é —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é: –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∏–∑ –¢—Ä–µ–∫–µ—Ä–∞ ‚Üí –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –≤ —Ç—Ä–µ–¥ –∑–∞–¥–∞—á–∏ –≤ –ü–∞—á–∫–µ
- –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∏–∑ –ü–∞—á–∫–∏ ‚Üí –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è –≤ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –¢—Ä–µ–∫–µ—Ä–∞
- –ø–æ–∏—Å–∫ –∑–∞–¥–∞—á –ø–æ –∫–∞—Å—Ç–æ–º–Ω—ã–º –ø–æ–ª—è–º
- –æ–±—Ä–∞–±–æ—Ç–∫—É –∫–Ω–æ–ø–æ–∫
- –∑–∞—â–∏—Ç—É –≤–µ–±—Ö—É–∫–æ–º –∏ HMAC-–ø–æ–¥–ø–∏—Å—å—é
- —Å–æ–∑–¥–∞–Ω–∏–µ —Ç—Ä–µ–¥–æ–≤ –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π
- –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å —Ü–∏–∫–ª–æ–≤
- –∑–∞–º–µ–Ω—É @–ª–æ–≥–∏–Ω–æ–≤ –Ø–Ω–¥–µ–∫—Å-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –Ω–∞ displayName –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π Pachca

–í–º–µ—Å—Ç–µ —ç—Ç–æ –æ–±—Ä–∞–∑—É–µ—Ç —É—Å—Ç–æ–π—á–∏–≤—É—é –¥–≤—É—Å—Ç–æ—Ä–æ–Ω–Ω—é—é –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é –¥–ª—è ServiceDesk.

# –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
1. –ü–æ–ª—É—á–µ–Ω–∏–µ –≤–µ–±—Ö—É–∫–æ–≤ –æ—Ç –ü–∞—á–∫–∏

–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø—Ä–∏–Ω–∏–º–∞–µ—Ç JSON –∏–∑ Pachca:
- –æ–±—ã—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è (type=message)
- –∫–Ω–æ–ø–∫–∏
- —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —Ç—Ä–µ–¥–∞—Ö (entity_type=thread)
- —Å–ª—É–∂–µ–±–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
- —Å–æ–±—ã—Ç–∏—è callback
- –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

–¢–µ–ª–æ –≤–µ–±—Ö—É–∫–∞ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –ø–æ HMAC-–ø–æ–¥–ø–∏—Å–∏ (pachca-signature) –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç –ø–æ—Å—Ç–æ—Ä–æ–Ω–Ω–∏—Ö –≤—ã–∑–æ–≤–æ–≤.

2. –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–¥–∞—á –≤ –Ø–Ω–¥–µ–∫—Å.–¢—Ä–µ–∫–µ—Ä–µ

–ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–æ–∑–¥–∞—ë—Ç –Ω–æ–≤—É—é –∑–∞—è–≤–∫—É, —Ñ—É–Ω–∫—Ü–∏—è:
1. –§–æ—Ä–º–∏—Ä—É–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∑–∞–¥–∞—á–∏
2. –î–æ–±–∞–≤–ª—è–µ—Ç —Ç–µ–≥ "–°–æ–∑–¥–∞–Ω–∞ –≤ –ü–∞—á–∫–µ"
3. –°–æ–∑–¥–∞—ë—Ç –∑–∞–¥–∞—á—É –≤ –æ—á–µ—Ä–µ–¥–∏ (SERVICEDESK)
4. –ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç –∫–ª—é—á –∑–∞–¥–∞—á–∏ –≤ custom-–ø–æ–ª–µ
5. –°–æ–∑–¥–∞—ë—Ç –æ—Ç–≤–µ—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –ü–∞—á–∫–µ ‚Üí –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∫–Ω–æ–ø–∫–∏ –∏ —Å—Å—ã–ª–∫—É –Ω–∞ –∑–∞–¥–∞—á—É

–î–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ–ª–µ–π –∑–∞–¥–∞—á–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è:

update_tracker_issue(issue_key, extra_fields)

3. –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –∏–∑ Tracker ‚Üí Pachca

–°–æ–±—ã—Ç–∏–µ issueCommentEvent –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ, **–±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–ø–∏—Å–∏**, —Ç–∞–∫ –∫–∞–∫ –ø—Ä–∏—Ö–æ–¥–∏—Ç –Ω–∞–ø—Ä—è–º—É—é –æ—Ç –Ø–Ω–¥–µ–∫—Å.Tracker.

–§—É–Ω–∫—Ü–∏—è:

1. –ò—â–µ—Ç –∫–∞—Å—Ç–æ–º–Ω–æ–µ –ø–æ–ª–µ pachcaMessageId
2. –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –∫ –∫–∞–∫–æ–º—É —Å–æ–æ–±—â–µ–Ω–∏—é/—Ç—Ä–µ–¥—É –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –∑–∞–¥–∞—á–∞
3. –§–æ—Ä–º–∏—Ä—É–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –≤–∏–¥–∞:

üîî –î–æ–±–∞–≤–ª–µ–Ω –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:
–ê–≤—Ç–æ—Ä: –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤
–¢–µ–∫—Å—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è


–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –µ–≥–æ –≤ —Ç—Ä–µ–¥ –∏–ª–∏ –≤ —á–∞—Ç –ü–∞—á–∫–∏

–ò—Å–ø–æ–ª—å–∑—É–µ—Ç –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è

4. –û–±—Ä–∞—Ç–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è: –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∏–∑ Pachca ‚Üí Tracker

–ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —á—Ç–æ-—Ç–æ –ø–∏—à–µ—Ç –≤ —Ç—Ä–µ–¥–µ –≤ –ü–∞—á–∫–µ, —ç—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –∑–∞–¥–∞—á–µ.

–§—É–Ω–∫—Ü–∏—è:

1. –ò–¥–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä—É–µ—Ç, —á—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ —Ç—Ä–µ–¥–∞
2. –ù–∞—Ö–æ–¥–∏—Ç —Å–≤—è–∑–∞–Ω–Ω—É—é –∑–∞–¥–∞—á—É –¢—Ä–µ–∫–µ—Ä–∞
3. –î–æ–±–∞–≤–ª—è–µ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —á–µ—Ä–µ–∑:

add_tracker_comment(issue_key, text)


4. –ò–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è, —Å–æ–∑–¥–∞–Ω–Ω—ã–µ —Å–∞–º–∏–º –±–æ—Ç–æ–º, —á—Ç–æ–±—ã –Ω–µ —Å–æ–∑–¥–∞–≤–∞—Ç—å —Ü–∏–∫–ª

5. –ü–æ–∏—Å–∫ –∑–∞–¥–∞—á –ø–æ –∫–∞—Å—Ç–æ–º–Ω–æ–º—É –ø–æ–ª—é ¬´PachcaUserId¬ª

6. –†–∞–±–æ—Ç–∞ —Å —Ç—Ä–µ–¥–∞–º–∏ Pachca
–°–æ–∑–¥–∞–Ω–∏–µ —Ç—Ä–µ–¥–∞:
create_thread_for_message(message_id)

–û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —Ç—Ä–µ–¥:
send_threaded_message(thread_entity_id=..., text="...")


–í–æ–∑–º–æ–∂–Ω–∞ –æ—Ç–ø—Ä–∞–≤–∫–∞:
- –Ω–∞–ø—Ä—è–º—É—é –≤ —Ç—Ä–µ–¥
- –≤ –æ—Ç–≤–µ—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É —Å–æ–æ–±—â–µ–Ω–∏—é
- –ø—Ä–æ—Å—Ç–æ –≤ —á–∞—Ç

7. –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å (anti-loop)

–ü—Ä–æ–±–ª–µ–º–∞:
–∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –≤ –¢—Ä–µ–∫–µ—Ä–µ ‚Üí –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –≤ —Ç—Ä–µ–¥ –ü–∞—á–∫–∏ ‚Üí —Ç—Ä–µ–¥ –ü–∞—á–∫–∏ —Å–æ–∑–¥–∞—ë—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π ‚Üí –Ω–æ–≤—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π ‚Üí –≤–Ω–æ–≤—å —Ç—Ä–µ–¥ ‚Üí —Ü–∏–∫–ª.

–†–µ—à–µ–Ω–∏–µ:
–ø—Ä–æ—Å—Ç–µ–π—à–µ–µ in-memory –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ ID –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤:

8. –ó–∞–º–µ–Ω–∞ —É–ø–æ–º–∏–Ω–∞–Ω–∏–π @username

–ï—Å–ª–∏ –≤ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –¢—Ä–µ–∫–µ—Ä–∞ –≤—Å—Ç—Ä–µ—á–∞–µ—Ç—Å—è —á—Ç–æ-—Ç–æ –≤—Ä–æ–¥–µ @ivan.petrov

–°–∫—Ä–∏–ø—Ç:
- –ø—ã—Ç–∞–µ—Ç—Å—è –Ω–∞–π—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è Pachca –ø–æ email / query
- –∑–∞–º–µ–Ω—è–µ—Ç —É–ø–æ–º–∏–Ω–∞–Ω–∏–µ –Ω–∞ –Ω–∏–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ü–∞—á–∫–µ, —á—Ç–æ–±—ã –æ–Ω –±—ã–ª –ø—Ä–∞–≤–∏–ª—å–Ω–æ —É–ø–æ–º—è–Ω—É—Ç –≤ –ü–∞—á–∫–µ

–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è:

find_pachca_user_by_query(query)

‚Ññ –ù–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è (.env)
- PACHKA_API_TOKEN=
- WEBHOOK_SECRET=
- TRACKER_API_TOKEN=
- TRACKER_ORG_ID=
- TRACKER_CREATE_URL=

- BOT_USER_ID=

- Y360_OAUTH=
- Y360_ORG_ID=

- PACHCA_EMAIL_DOMAIN=bnovo.ru
- TRACKER_QUEUE=SERVICEDESK

# –î–µ–ø–ª–æ–π

–û–±—ã—á–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –Ø–Ω–¥–µ–∫—Å –§—É–Ω–∫—Ü–∏—è:

- runtime: Python 3.12/3.10
- timeout: 30 —Å–µ–∫
- memory: 1024 MB

–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:

- requests

# –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã handler:

1. –ü—Ä–∏–Ω–∏–º–∞–µ—Ç HTTP webhook
2. –ü—ã—Ç–∞–µ—Ç—Å—è –±—ã—Å—Ç—Ä–æ —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å issueCommentEvent
3. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–æ–¥–ø–∏—Å—å HMAC
4. –§–∏–ª—å—Ç—Ä—É–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –±–æ—Ç–∞
5. –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ç–∏–ø —Å–æ–±—ã—Ç–∏—è –î–µ–π—Å—Ç–≤–∏–µ:
- message –≤ —á–∞—Ç–µ —Å–æ–∑–¥–∞—ë—Ç –∑–∞–¥–∞—á—É –≤ —Ç—Ä–µ–∫–µ—Ä–µ
- message –≤ —Ç—Ä–µ–¥–µ	–¥–æ–±–∞–≤–ª—è–µ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –≤ –∑–∞–¥–∞—á—É
- –∫–Ω–æ–ø–∫–∞ –º–µ–Ω—è–µ—Ç —Å—Ç–∞—Ç—É—Å, –≤—ã–∑—ã–≤–∞–µ—Ç –∫–æ–º–∞–Ω–¥—ã
- issueCommentEvent	–æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –≤ —Ç—Ä–µ–¥ –ü–∞—á–∫–∏
–¥—Ä—É–≥–æ–µ	–∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è

6. –í—Å—ë –ª–æ–≥–∏—Ä—É–µ—Ç
7. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π HTTP —Å—Ç–∞—Ç—É—Å
