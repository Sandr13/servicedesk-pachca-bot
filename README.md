# servicedesk-pachca-bot
Серверless-обработчик (деплой в Яндекс Функции), который позволяет создавать задачи в Yandex Tracker, а также обеспечивает двустороннюю связь между Pachca и Яндекс.Tracker.

# Файл index.py реализует:

- создание задач в Трекере из сообщений в Пачке
- обратную синхронизацию: комментарии из Трекера → отправляются в тред задачи в Пачке
- комментарии из Пачки → добавляются в комментарии Трекера
- поиск задач по кастомным полям
- обработку кнопок
- защиту вебхуком и HMAC-подписью
- создание тредов для сообщений
- идемпотентность, чтобы избежать циклов
- замену @логинов Яндекс-пользователей на displayName пользователей Pachca

Вместе это образует двустороннюю интеграцию для ServiceDesk.

# Основные функции
1. Получение вебхуков от Пачки

Обработчик принимает JSON из Pachca:
- обычные сообщения (type=message)
- кнопки
- сообщения в тредах (entity_type=thread)
- служебные сообщения
- события callback
- данные пользователя

Тело вебхука проверяется по HMAC-подписи (pachca-signature) для защиты от посторонних вызовов.

2. Создание задач в Яндекс.Трекере

Если сообщение создаёт новую заявку, функция:
1. Формирует структуру задачи
2. Добавляет тег "Создана в Пачке"
3. Создаёт задачу в очереди (SERVICEDESK)
4. Записывает ключ задачи в custom-поле
5. Создаёт ответное сообщение в Пачке → отправляет кнопки и ссылку на задачу

Для обновления полей задачи используется:

update_tracker_issue(issue_key, extra_fields)

3. Обработка комментариев из Tracker → Pachca

Событие issueCommentEvent обрабатывается мгновенно, **без проверки подписи**, так как приходит напрямую от Яндекс.Tracker.

Функция:

1. Ищет кастомное поле pachcaMessageId
2. Определяет к какому сообщению/треду относится задача
3. Формирует сообщение вида:
Добавлен комментарий:
Автор: Иван Иванов
Текст комментария


Отправляет его в тред или в чат Пачки

Использует идемпотентность, чтобы избежать дублирования

4. Обратная синхронизация: комментарии из Pachca → Tracker

Если пользователь что-то пишет в треде в Пачке, это означает комментарий к задаче.

Функция:

1. Идентифицирует, что сообщение находится внутри треда
2. Находит связанную задачу Трекера
3. Добавляет комментарий через:

add_tracker_comment(issue_key, text)


4. Игнорирует сообщения, созданные самим ботом, чтобы не создавать цикл

5. Поиск задач по кастомному полю «PachcaUserId»

6. Работа с тредами Pachca
Создание треда:
create_thread_for_message(message_id)

Отправка сообщения в тред:
send_threaded_message(thread_entity_id=..., text="...")


Возможна отправка:
- напрямую в тред
- в ответ конкретному сообщению
- просто в чат

7. Идемпотентность (anti-loop)

Проблема:
комментарий в Трекере → отправляется в тред Пачки → тред Пачки создаёт комментарий → новый комментарий → вновь тред → цикл.

Решение:
простейшее in-memory кеширование ID комментариев:

8. Замена упоминаний @username

Если в комментарии Трекера встречается что-то вроде @ivan.petrov

Скрипт:
- пытается найти пользователя Pachca по email / query
- заменяет упоминание на ник пользователя в Пачке, чтобы он был правильно упомянут в Пачке

Используется:

find_pachca_user_by_query(query)

№ Необходимые переменные окружения (.env)
- PACHKA_API_TOKEN=
- WEBHOOK_SECRET=
- TRACKER_API_TOKEN=
- TRACKER_ORG_ID=
- TRACKER_CREATE_URL=

- BOT_USER_ID=

- Y360_OAUTH=
- Y360_ORG_ID=

- PACHCA_EMAIL_DOMAIN=bnovo.ru
- TRACKER_QUEUE=SERVICEDESK

# Деплой

Обычно используется Яндекс Функция:

- runtime: Python 3.12/3.10
- timeout: 30 сек
- memory: 1024 MB

Зависимости:

- requests

# Логика работы handler:

1. Принимает HTTP webhook
2. Пытается быстро распознать issueCommentEvent
3. Проверяет подпись HMAC
4. Фильтрует сообщения бота
5. Определяет тип события Действие:
- message в чате создаёт задачу в трекере
- message в треде	добавляет комментарий в задачу
- кнопка меняет статус, вызывает команды
- issueCommentEvent	отправляет комментарий в тред Пачки
другое	игнорируется

6. Всё логирует
7. Возвращает корректный HTTP статус
